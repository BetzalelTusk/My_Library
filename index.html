<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LibraryOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        tailwind.config = {
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        library: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' }
                    }
                } 
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .fade-enter { animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass-overlay { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; border: 2px solid #f8fafc; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .input-focus { @apply focus:ring-4 focus:ring-library-100 focus:border-library-500 transition-all duration-200; }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden font-sans antialiased selection:bg-library-100 selection:text-library-900">

    <aside class="w-72 bg-white border-r border-slate-200 flex flex-col justify-between hidden md:flex z-20 shadow-[4px_0_24px_-12px_rgba(0,0,0,0.1)]">
        <div>
            <div class="h-24 flex items-center px-8 border-b border-slate-50">
                <div class="flex items-center gap-3 text-library-600">
                    <div class="bg-library-50 p-2 rounded-xl">
                        <i class="ph-fill ph-books text-2xl"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight text-slate-900">LibraryOS</span>
                </div>
            </div>

            <nav class="p-6 space-y-2">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 px-2">Main Menu</div>
                <button onclick="showPage('catalog', this)" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 text-sm font-medium rounded-xl bg-library-50 text-library-700 transition-all duration-200 group">
                    <i class="ph ph-book-open text-xl group-hover:scale-110 transition-transform"></i> Catalogue
                </button>
                <button onclick="showPage('borrow', this)" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 text-sm font-medium rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-900 transition-all duration-200 group">
                    <i class="ph ph-upload-simple text-xl group-hover:scale-110 transition-transform"></i> Check Out
                </button>
                <button onclick="showPage('return', this)" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 text-sm font-medium rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-900 transition-all duration-200 group">
                    <i class="ph ph-download-simple text-xl group-hover:scale-110 transition-transform"></i> Check In
                </button>
                <div class="pt-6 mt-4 border-t border-slate-50">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 px-2">Personal</div>
                    <button onclick="showPage('myaccount', this)" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 text-sm font-medium rounded-xl text-slate-500 hover:bg-emerald-50 hover:text-emerald-700 transition-all duration-200 group">
                        <i class="ph ph-user-circle text-xl group-hover:scale-110 transition-transform"></i> My History
                    </button>
                </div>
            </nav>
        </div>
        <div class="p-6 border-t border-slate-50">
            <button onclick="checkAdmin()" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 text-sm font-medium rounded-xl text-slate-500 hover:bg-rose-50 hover:text-rose-600 transition-all duration-200 group">
                <i class="ph ph-lock-key text-xl group-hover:scale-110 transition-transform"></i> Admin Panel
            </button>
        </div>
    </aside>

    <div class="md:hidden fixed top-0 w-full bg-white/90 backdrop-blur-md border-b z-30 px-4 h-16 flex items-center justify-between">
        <span class="font-bold text-lg text-library-600 flex items-center gap-2"><i class="ph-fill ph-books"></i> LibraryOS</span>
        <button onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('absolute'); document.querySelector('aside').classList.toggle('h-full');" class="p-2 rounded-lg bg-slate-100 text-slate-600">
            <i class="ph ph-list text-xl"></i>
        </button>
    </div>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative pt-16 md:pt-0 bg-[#f8fafc]">
        <header class="h-24 flex items-center justify-between px-8 md:px-12 shrink-0">
            <div>
                <h2 id="pageTitle" class="text-2xl font-bold text-slate-800 tracking-tight">Catalogue</h2>
                <p id="pageSubtitle" class="text-sm text-slate-500 font-medium mt-1">Manage library inventory</p>
            </div>
            <div class="hidden sm:flex items-center gap-2 bg-white px-4 py-2 rounded-full border border-slate-200 shadow-sm">
                <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                <p class="text-xs font-bold text-slate-600 uppercase tracking-wide">System Online</p>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto px-4 md:px-12 pb-12">
            
            <div id="catalog" class="page-section fade-enter max-w-7xl mx-auto">
                <div class="relative group mb-8 shadow-sm">
                    <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none">
                        <i class="ph ph-magnifying-glass text-slate-400 text-xl group-focus-within:text-library-500 transition-colors"></i>
                    </div>
                    <input type="text" id="searchBox" onkeyup="filterCatalog()" class="block w-full pl-14 pr-4 py-5 bg-white border border-slate-200 rounded-2xl text-lg shadow-sm input-focus placeholder-slate-400" placeholder="Search by title, author, or scan barcode...">
                </div>
                <div class="bg-white rounded-3xl shadow-[0_2px_12px_-4px_rgba(0,0,0,0.05)] border border-slate-100 overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 text-xs font-bold uppercase text-slate-500 tracking-wider">
                            <tr>
                                <th class="p-5 border-b border-slate-100 w-32">ID</th>
                                <th class="p-5 border-b border-slate-100">Title & Details</th>
                                <th class="p-5 border-b border-slate-100">Category</th>
                                <th class="p-5 border-b border-slate-100 text-right">Availability</th>
                            </tr>
                        </thead>
                        <tbody id="bookTable" class="divide-y divide-slate-50 text-sm"></tbody>
                    </table>
                    <div id="emptyCatalogState" class="hidden p-12 text-center">
                        <div class="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400">
                            <i class="ph ph-books text-3xl"></i>
                        </div>
                        <h3 class="text-slate-900 font-bold text-lg">No books found</h3>
                    </div>
                </div>
            </div>

            <div id="borrow" class="page-section hidden fade-enter min-h-full flex flex-col items-center pt-8 pb-20">
                <div class="w-full max-w-lg">
                    <div class="bg-white rounded-3xl shadow-xl border border-slate-100 p-8 md:p-10 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-library-500 to-indigo-400"></div>
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-library-50 text-library-600 rounded-2xl flex items-center justify-center mx-auto mb-4"><i class="ph-fill ph-shopping-cart text-3xl"></i></div>
                            <h2 class="text-2xl font-bold text-slate-800">Check Out Cart</h2>
                            <p class="text-slate-500 text-sm">Scan user, then scan books to add to cart</p>
                        </div>
                        
                        <div class="space-y-5">
                            <div>
                                <label class="text-[10px] font-bold uppercase text-slate-400 tracking-widest ml-1 mb-1 block">1. Identify User</label>
                                <input type="email" id="borrowEmail" onblur="identifyUser()" onkeydown="if(event.key==='Enter') identifyUser()" class="block w-full p-3 bg-white border border-slate-200 rounded-xl text-sm input-focus mb-1" placeholder="Scan Student ID or Type Email">
                                <p id="borrowIdentityMsg" class="text-xs font-bold text-center h-4"></p>
                            </div>

                            <div class="relative">
                                <label class="text-[10px] font-bold uppercase text-slate-400 tracking-widest ml-1 mb-1 block">2. Scan Books</label>
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i class="ph-bold ph-scan text-library-500 text-lg"></i></div>
                                    <input type="text" id="borrowBarcode" onkeydown="handleBarcode(event, 'borrow')" class="block w-full pl-12 p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-mono tracking-widest text-lg focus:bg-white focus:border-library-500 focus:ring-0 transition-all placeholder-slate-400" placeholder="Scan Books...">
                                </div>
                            </div>

                            <div class="bg-slate-50 rounded-2xl border border-slate-100 p-4 max-h-40 overflow-y-auto">
                                <p id="emptyCartMsg" class="text-center text-xs text-slate-400 italic py-2">Cart is empty. Scan books to add.</p>
                                <ul id="cartList" class="space-y-2 text-sm"></ul>
                            </div>

                            <button onclick="processCheckout()" class="w-full py-4 bg-library-600 hover:bg-library-700 text-white font-bold rounded-2xl shadow-lg shadow-library-500/30 transition-all active:scale-[0.98] flex items-center justify-center gap-2">
                                <span id="checkoutBtnText">Complete Checkout</span>
                                <i class="ph-bold ph-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="return" class="page-section hidden fade-enter min-h-full flex flex-col items-center pt-8 pb-20">
                <div class="w-full max-w-lg">
                    <div class="bg-white rounded-3xl shadow-xl border border-slate-100 p-8 md:p-10 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-emerald-500 to-teal-400"></div>
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center mx-auto mb-4"><i class="ph-fill ph-download-simple text-3xl"></i></div>
                            <h2 class="text-2xl font-bold text-slate-800">Check In</h2>
                            <p class="text-slate-500 text-sm">Return items to the inventory</p>
                        </div>
                        <div class="space-y-5">
                            <div class="relative">
                                <label class="text-[10px] font-bold uppercase text-slate-400 tracking-widest ml-1 mb-1 block">Quick Scan</label>
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i class="ph-bold ph-scan text-emerald-500 text-lg"></i></div>
                                    <input type="text" id="returnBarcode" onkeydown="handleBarcode(event, 'return')" class="block w-full pl-12 p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-mono tracking-widest text-lg focus:bg-white focus:border-emerald-500 focus:ring-0 transition-all placeholder-slate-400" placeholder="Scan Barcode...">
                                </div>
                            </div>
                            <p class="text-xs text-slate-400 text-center italic">Scanning a book will instantly return it.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="myaccount" class="page-section hidden fade-enter max-w-3xl mx-auto pt-4">
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-8 border-b border-slate-100 bg-slate-50/50">
                        <h3 class="text-xl font-bold text-slate-900">Member Portal</h3>
                        <p class="text-slate-500 text-sm">View your history and manage account settings</p>
                    </div>
                    <div class="p-8">
                        <div id="authStep1" class="flex gap-3">
                            <input type="email" id="authEmail" class="flex-1 p-4 bg-slate-50 border border-slate-200 rounded-2xl input-focus" placeholder="Enter your email address...">
                            <button onclick="checkUserStatus()" class="px-8 py-4 bg-slate-800 text-white font-bold rounded-2xl hover:bg-slate-900 transition-all shadow-lg shadow-slate-200">Next</button>
                        </div>
                        <div id="authStep2" class="hidden mt-6 space-y-4 animate-slideUpFade">
                            <div class="bg-indigo-50/50 p-6 rounded-2xl border border-indigo-100">
                                <p id="authMessage" class="text-sm font-medium text-slate-600 mb-4">Verify Identity</p>
                                <div id="authNameField" class="hidden mb-3">
                                    <input type="text" id="authNameInput" class="block w-full p-3.5 border border-slate-200 rounded-xl text-sm" placeholder="Full Name">
                                </div>
                                <div id="authIdField" class="hidden mb-3">
                                    <input type="text" id="authIdInput" class="block w-full p-3.5 border border-slate-200 rounded-xl font-mono text-sm" placeholder="Scan ID Card (Optional)">
                                </div>
                                <div class="flex gap-3">
                                    <input type="password" id="authPassword" class="flex-1 p-3.5 border border-slate-200 rounded-xl text-sm" placeholder="Password" autocomplete="new-password">
                                    <button id="authBtnAction" class="px-6 py-3.5 bg-library-600 text-white font-bold rounded-xl hover:bg-library-700 shadow-md">Login</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="myHistoryResults" class="hidden">
                        <div class="bg-indigo-900 text-white p-6 mx-6 rounded-2xl shadow-inner mb-6 relative overflow-hidden">
                            <div class="absolute right-0 top-0 opacity-10"><i class="ph-fill ph-books text-9xl"></i></div>
                            <h4 class="font-bold text-indigo-100 uppercase tracking-widest text-xs mb-2">Active Loans</h4>
                            <ul id="myActiveList" class="space-y-2 relative z-10 text-lg font-medium"></ul>
                            <div class="mt-6 pt-4 border-t border-indigo-800 flex gap-3 relative z-10">
                                <button onclick="openCollateralModal()" class="px-4 py-2 bg-indigo-800/50 hover:bg-indigo-700 rounded-lg text-xs font-bold uppercase tracking-wide border border-indigo-700 transition-colors flex items-center gap-2"><i class="ph-fill ph-credit-card"></i> Collateral</button>
                                <button onclick="openLinkIDModal()" class="px-4 py-2 bg-indigo-800/50 hover:bg-indigo-700 rounded-lg text-xs font-bold uppercase tracking-wide border border-indigo-700 transition-colors flex items-center gap-2"><i class="ph-fill ph-identification-card"></i> Link ID</button>
                            </div>
                        </div>
                        <div class="px-8 pb-8">
                            <h4 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="ph-bold ph-clock-counter-clockwise"></i> History Log</h4>
                            <div class="overflow-hidden rounded-xl border border-slate-100">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-50 text-xs text-slate-400 uppercase font-bold"><tr><th class="p-3 pl-4">Date</th><th class="p-3">Action</th><th class="p-3">Book</th></tr></thead>
                                    <tbody id="myHistoryTable" class="divide-y divide-slate-50 bg-white"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="admin" class="page-section hidden fade-enter max-w-[90rem] mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                    <div><h3 class="text-2xl font-bold text-slate-800">Admin Dashboard</h3><p class="text-slate-500">System Overview & Alerts</p></div>
                    <div class="flex gap-2">
                        <button onclick="reloadCatalog()" class="px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-600 hover:bg-slate-50 transition-colors shadow-sm">Refresh Data</button>
                        <button onclick="logoutAdmin()" class="px-4 py-2.5 bg-rose-50 text-rose-600 rounded-xl text-sm font-bold hover:bg-rose-100 transition-colors">Logout</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                        <div class="p-3 bg-blue-50 text-blue-600 rounded-xl"><i class="ph-fill ph-users text-2xl"></i></div>
                        <div><p class="text-xs font-bold text-slate-400 uppercase">Active Students</p><p class="text-xl font-bold text-slate-800" id="statUsers">-</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                        <div class="p-3 bg-orange-50 text-orange-600 rounded-xl"><i class="ph-fill ph-book-open text-2xl"></i></div>
                        <div><p class="text-xs font-bold text-slate-400 uppercase">Books Out</p><p class="text-xl font-bold text-slate-800" id="statLoans">-</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                        <div class="p-3 bg-rose-50 text-rose-600 rounded-xl"><i class="ph-fill ph-warning-circle text-2xl"></i></div>
                        <div><p class="text-xs font-bold text-slate-400 uppercase">Overdue</p><p class="text-xl font-bold text-slate-800" id="statOverdue">-</p></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    <div class="xl:col-span-2 bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center"><h4 class="font-bold text-slate-800 flex items-center gap-2"><i class="ph-fill ph-hourglass-medium text-orange-500"></i> Active Loans</h4></div>
                        <div class="overflow-x-auto flex-1">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 text-xs uppercase text-slate-400 font-bold"><tr><th class="p-4 text-left">Student</th><th class="p-4 text-left">Collateral</th><th class="p-4 text-left">Book</th><th class="p-4 text-left">Due Status</th></tr></thead>
                                <tbody id="adminActiveTable" class="divide-y divide-slate-50"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[600px]">
                        <div class="p-6 border-b border-slate-100"><h4 class="font-bold text-slate-800">Transaction Log</h4></div>
                        <div class="overflow-y-auto flex-1 p-0">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 text-xs uppercase text-slate-400 sticky top-0 z-10 font-bold"><tr><th class="p-3 pl-6 text-left">Type</th><th class="p-3 text-left">User</th><th class="p-3 text-left">Detail</th></tr></thead>
                                <tbody id="adminHistoryTable" class="divide-y divide-slate-50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="loginOverlay" class="fixed inset-0 glass-overlay z-50 hidden flex items-center justify-center fade-enter">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center">
            <div class="w-12 h-12 bg-slate-900 text-white rounded-full flex items-center justify-center mx-auto mb-4"><i class="ph-bold ph-lock-key text-xl"></i></div>
            <h3 class="text-xl font-bold mb-6">Restricted Access</h3>
            <input type="password" id="adminPassInput" onkeydown="if(event.key==='Enter') attemptLogin()" class="block w-full text-center text-2xl tracking-[0.2em] px-4 py-4 bg-slate-50 border-2 border-slate-100 rounded-2xl mb-4 focus:border-slate-900 focus:bg-white transition-colors outline-none" placeholder="••••" autocomplete="new-password">
            <p id="loginError" class="text-rose-500 text-xs font-bold mb-4 hidden bg-rose-50 py-2 rounded-lg">Incorrect Password</p>
            <button onclick="attemptLogin()" class="w-full py-3.5 bg-slate-900 text-white font-bold rounded-xl hover:bg-black transition-transform active:scale-95">Unlock Panel</button>
            <button onclick="closeLogin()" class="w-full py-3 mt-2 text-slate-400 text-sm hover:text-slate-600">Return</button>
        </div>
    </div>

    <div id="collateralModal" class="fixed inset-0 glass-overlay z-50 hidden flex items-center justify-center fade-enter">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-purple-600 to-indigo-600"></div>
            <button onclick="document.getElementById('collateralModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="ph-bold ph-x text-lg"></i></button>
            <h3 class="text-xl font-bold text-center mb-1">Secure Collateral</h3>
            <div class="flex items-center justify-center gap-2 text-xs text-emerald-600 bg-emerald-50 py-1 px-3 rounded-full w-fit mx-auto mb-6 font-medium"><i class="ph-fill ph-lock-key"></i> AES-256 Encrypted</div>
            <div class="space-y-3">
                <input type="text" id="ccName" class="block w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-sm input-focus" placeholder="Name on Card" autocomplete="off">
                <input type="text" id="ccNumber" class="block w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-mono input-focus" placeholder="Card Number" autocomplete="off">
                <div class="flex gap-3">
                    <input type="text" id="ccExp" class="flex-1 p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-sm text-center input-focus" placeholder="MM/YY" autocomplete="off">
                    <input type="text" id="ccCvv" class="w-24 p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-sm text-center input-focus" placeholder="CVV" autocomplete="off">
                </div>
                <button onclick="submitCollateral()" class="w-full py-3.5 bg-slate-900 text-white font-bold rounded-xl mt-2 hover:bg-black shadow-lg">Encrypt & Save</button>
            </div>
        </div>
    </div>

    <div id="linkIDModal" class="fixed inset-0 glass-overlay z-50 hidden flex items-center justify-center fade-enter">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm relative text-center">
            <button onclick="document.getElementById('linkIDModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="ph-bold ph-x text-lg"></i></button>
            <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4"><i class="ph-fill ph-identification-card text-3xl"></i></div>
            <h3 class="text-xl font-bold mb-2">Link Student ID</h3>
            <p class="text-slate-500 text-sm mb-6">Scan your physical ID card now to link it to your account.</p>
            <input type="text" id="linkIDInput" onkeydown="handleLinkID(event)" class="block w-full p-4 bg-slate-50 border-2 border-indigo-100 rounded-2xl text-center font-mono text-lg focus:border-indigo-500 focus:bg-white outline-none transition-colors" placeholder="Scan ID..." autocomplete="off">
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-[0_10px_40px_-10px_rgba(0,0,0,0.3)] translate-y-24 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
        <div id="toastIcon" class="text-emerald-400"><i class="ph-fill ph-check-circle text-xl"></i></div>
        <p id="toastMessage" class="font-medium text-sm">Notification</p>
    </div>

    <script>
        let allBooks = [], activeStudents = [], adminPassword = "";
        let checkoutCart = []; 

        function safe(str) {
            if(!str) return '';
            // Decode HTML entities (like &#039;) first using a textarea hack
            const txt = document.createElement('textarea');
            txt.innerHTML = str;
            const decoded = txt.value;
            // Then re-sanitize
            const div = document.createElement('div');
            div.textContent = decoded;
            return div.innerHTML;
        }

        // --- NEW FUNCTION: Groups books by Title ---
        function groupBooks(list) {
            const groups = {};
            list.forEach(b => {
                // Normalize key: trim whitespace and lowercase to group accurately
                const key = b.name.trim().toLowerCase(); 
                if (!groups[key]) {
                    groups[key] = {
                        ...b,
                        _ids: [b.id], // track all IDs
                        _totalAvailable: parseInt(b.available) || 0
                    };
                } else {
                    groups[key]._ids.push(b.id);
                    groups[key]._totalAvailable += (parseInt(b.available) || 0);
                }
            });
            return Object.values(groups);
        }

        function showPage(pageId, btn) {
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('bg-library-50', 'text-library-700'); el.classList.add('text-slate-500'); });
            if(btn) { btn.classList.remove('text-slate-500'); btn.classList.add('bg-library-50', 'text-library-700'); }
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            const titles = { 'catalog': 'Catalogue', 'borrow': 'Check Out', 'return': 'Check In', 'admin': 'Admin', 'myaccount': 'User History' };
            const subtitles = { 'catalog': 'Manage library inventory', 'borrow': 'Process new loans', 'return': 'Process returns', 'admin': 'System Dashboard', 'myaccount': 'Your reading log' };
            if(titles[pageId]) {
                document.getElementById('pageTitle').innerText = titles[pageId];
                document.getElementById('pageSubtitle').innerText = subtitles[pageId];
            }
            if(pageId === 'borrow') { checkoutCart = []; renderCart(); setTimeout(() => document.getElementById('borrowBarcode').focus(), 100); }
            if(pageId === 'return') setTimeout(() => document.getElementById('returnBarcode').focus(), 100);
            if(pageId === 'catalog') loadCatalog();
            if(pageId === 'borrow') loadCatalog();
            if(pageId === 'return') loadReturnList();
            if(pageId === 'myaccount') resetUserAuthUI(); 
        }

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            document.getElementById('toastMessage').innerText = msg;
            if(type === 'error') { icon.innerHTML = '<i class="ph-fill ph-warning-circle text-xl"></i>'; icon.className = 'text-rose-400'; } 
            else { icon.innerHTML = '<i class="ph-fill ph-check-circle text-xl"></i>'; icon.className = 'text-emerald-400'; }
            t.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-24', 'opacity-0'), 3000);
        }

        async function loadCatalog() {
            try {
                const res = await fetch('api.php?action=books');
                allBooks = await res.json();
                renderTable(allBooks);
                document.getElementById('statTotal').innerText = allBooks.length; // This counts total copies
            } catch(e) { console.error(e); }
        }

        function renderTable(books) {
            // Apply grouping before rendering
            const groupedBooks = groupBooks(books);

            const tbody = document.getElementById('bookTable');
            const emptyState = document.getElementById('emptyCatalogState');
            
            if(groupedBooks.length === 0) { tbody.innerHTML = ''; emptyState.classList.remove('hidden'); return; }
            emptyState.classList.add('hidden');

            tbody.innerHTML = groupedBooks.map(b => {
                const availableCount = b._totalAvailable;
                const available = availableCount > 0;
                
                // Badge Logic
                const statusBadge = available 
                    ? `<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-emerald-50 text-emerald-700 border border-emerald-100"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Available (${availableCount})</span>` 
                    : `<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-rose-50 text-rose-700 border border-rose-100">Out of Stock</span>`;
                
                // ID Display Logic
                let idDisplay = safe(b._ids[0]);
                if (b._ids.length > 1) {
                    idDisplay += ` <span class="text-[10px] bg-slate-100 text-slate-500 px-1 rounded ml-1">+${b._ids.length - 1}</span>`;
                }

                return `<tr class="hover:bg-slate-50/80 transition-colors group">
                    <td class="p-5 font-mono text-xs text-slate-400 group-hover:text-slate-600">${idDisplay}</td>
                    <td class="p-5">
                        <p class="font-bold text-slate-800 text-sm">${safe(b.name)}</p>
                        <p class="text-xs text-slate-400 mt-0.5">Shelf: ${safe(b.shelf)}</p>
                    </td>
                    <td class="p-5">
                        <span class="px-2.5 py-1 rounded-lg bg-slate-100 text-slate-500 text-xs font-bold border border-slate-200">${safe(b.category)}</span>
                    </td>
                    <td class="p-5 text-right">${statusBadge}</td>
                </tr>`;
            }).join('');
        }

        function filterCatalog() {
            const term = document.getElementById('searchBox').value.toLowerCase();
            // We filter the RAW list first, so you can still search by specific barcode
            const filteredRaw = allBooks.filter(b => b.name.toLowerCase().includes(term) || String(b.id).includes(term));
            renderTable(filteredRaw);
        }

        async function handleBarcode(event, type) {
            if (event.key !== 'Enter') return;
            event.preventDefault(); 
            const code = event.target.value.trim();
            if (!code) return;

            const book = allBooks.find(b => String(b.id) === code);
            if (book) {
                if (type === 'borrow') {
                    if (book.available > 0) { addToCart(book); showToast(`Added to Cart: ${book.name}`); event.target.value = ''; } 
                    else { showToast('Book Out of Stock', 'error'); event.target.value = ''; }
                } else if (type === 'return') {
                    const student = activeStudents.find(s => s.books.includes(book.name));
                    if (student) {
                        const res = await fetch('api.php?action=transaction', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ student: student.name, book: book.name, action: 'Return' }) });
                        if(res.ok) { showToast('Returned: ' + book.name); loadReturnList(); event.target.value = ''; }
                        else { showToast('Error returning', 'error'); }
                    } else { showToast('Book not checked out', 'error'); event.target.value = ''; }
                }
                return;
            }

            if (type === 'borrow') {
                const res = await fetch('api.php?action=lookup_student_id', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ student_id: code }) });
                const data = await res.json();
                if(data.found) {
                    document.getElementById('borrowEmail').value = data.email;
                    identifyUser(); event.target.value = ''; showToast(`Student ID Scanned: ${data.name}`);
                } else { showToast("Unknown Barcode", 'error'); event.target.value = ''; }
            } else { showToast("Barcode not found", 'error'); event.target.value = ''; }
        }

        function addToCart(book) {
            if(checkoutCart.find(b => b.id === book.id)) return showToast("Book already in cart", 'error');
            checkoutCart.push(book); renderCart();
        }
        function removeFromCart(index) { checkoutCart.splice(index, 1); renderCart(); }
        function renderCart() {
            const list = document.getElementById('cartList');
            const emptyMsg = document.getElementById('emptyCartMsg');
            const btnText = document.getElementById('checkoutBtnText');
            list.innerHTML = '';
            if(checkoutCart.length === 0) { emptyMsg.classList.remove('hidden'); btnText.innerText = "Complete Checkout"; } 
            else {
                emptyMsg.classList.add('hidden'); btnText.innerText = `Checkout ${checkoutCart.length} Books`;
                checkoutCart.forEach((b, index) => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center bg-white p-2 rounded border border-slate-200";
                    li.innerHTML = `<span class="font-medium text-slate-700 truncate">${b.name}</span><button onclick="removeFromCart(${index})" class="text-rose-500 hover:text-rose-700 ml-2"><i class="ph-bold ph-trash"></i></button>`;
                    list.appendChild(li);
                });
            }
        }

        function resetUserAuthUI() {
            document.getElementById('myHistoryResults').classList.add('hidden');
            document.getElementById('authStep2').classList.add('hidden');
            document.getElementById('authStep1').classList.remove('hidden');
            document.getElementById('authNameField').classList.add('hidden'); 
            document.getElementById('authIdField').classList.add('hidden'); 
            const emailInput = document.getElementById('authEmail');
            emailInput.disabled = false; emailInput.value = '';
            const passField = document.getElementById('authPassword');
            passField.value = ''; passField.setAttribute('autocomplete', 'new-password'); 
            document.getElementById('authNameInput').value = '';
            document.getElementById('authMessage').innerText = "Verify Identity";
            setTimeout(() => emailInput.focus(), 100);
        }

        async function checkUserStatus() {
            const email = document.getElementById('authEmail').value.trim();
            if(!email) return showToast("Enter email", 'error');
            const nextBtn = document.querySelector('#authStep1 button');
            nextBtn.innerText = "Checking..."; nextBtn.disabled = true;
            try {
                const res = await fetch('api.php?action=check_user_status', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email }) });
                const data = await res.json();
                document.getElementById('authStep2').classList.remove('hidden');
                document.getElementById('authEmail').disabled = true; 
                const btn = document.getElementById('authBtnAction');
                const msg = document.getElementById('authMessage');
                const passInput = document.getElementById('authPassword');
                const newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn);
                const newPassInput = passInput.cloneNode(true); passInput.parentNode.replaceChild(newPassInput, passInput);
                if(data.status === 'exists') {
                    msg.innerHTML = `Welcome back, <span class="font-bold text-slate-800">${safe(data.name)}</span>`;
                    newPassInput.focus(); newBtn.innerText = "Login";
                    const loginAction = () => performLogin(email);
                    newBtn.onclick = loginAction;
                    newPassInput.onkeydown = (e) => { if(e.key === 'Enter') loginAction(); };
                } else {
                    msg.innerHTML = "New Account Registration";
                    document.getElementById('authNameField').classList.remove('hidden'); document.getElementById('authIdField').classList.remove('hidden'); 
                    document.getElementById('authNameInput').focus(); newBtn.innerText = "Create Account";
                    const regAction = () => performRegistration(email);
                    newBtn.onclick = regAction;
                    newPassInput.onkeydown = (e) => { if(e.key === 'Enter') regAction(); };
                    document.getElementById('authNameInput').onkeydown = (e) => { if(e.key === 'Enter') regAction(); };
                }
            } catch (e) { console.error(e); showToast("Connection Error", "error"); } finally { nextBtn.innerText = "Next"; nextBtn.disabled = false; }
        }

        async function performRegistration(email) {
            const password = document.getElementById('authPassword').value;
            const name = document.getElementById('authNameInput').value;
            const sid = document.getElementById('authIdInput').value;
            if(!password || !name) return showToast("Name & Password required", 'error');
            const btn = document.getElementById('authBtnAction');
            btn.innerText = "Creating..."; btn.disabled = true;
            try {
                const res = await fetch('api.php?action=register_user', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email, password, name, student_id: sid }) });
                if(res.ok) { showToast("Account Created!"); await performLogin(email, password); } 
                else { const data = await res.json(); showToast(data.error || "Failed", 'error'); btn.innerText = "Create Account"; btn.disabled = false; }
            } catch(e) { console.error(e); btn.innerText = "Create Account"; btn.disabled = false; }
        }

        async function performLogin(email, overridePassword = null) {
            const password = overridePassword || document.getElementById('authPassword').value;
            if(!password) return showToast("Enter Password", 'error');
            const btn = document.getElementById('authBtnAction');
            if(btn) { btn.innerText = "Verifying..."; btn.disabled = true; }
            try {
                const res = await fetch('api.php?action=user_history', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email, password }) });
                if(res.status === 403 || res.status === 401) { showToast("Incorrect Password", 'error'); document.getElementById('authPassword').value = ''; document.getElementById('authPassword').focus(); if(btn) { btn.innerText = "Login"; btn.disabled = false; } } 
                else { const data = await res.json(); renderHistory(data); }
            } catch(e) { console.error(e); if(btn) { btn.innerText = "Retry"; btn.disabled = false; } }
        }

        function renderHistory(data) {
            document.getElementById('authStep1').classList.add('hidden'); document.getElementById('authStep2').classList.add('hidden'); document.getElementById('myHistoryResults').classList.remove('hidden');
            const activeDiv = document.getElementById('myActiveList');
            if(data.active.length === 0) { activeDiv.innerHTML = '<li class="text-indigo-200 text-sm italic py-2">No active loans.</li>'; } 
            else { activeDiv.innerHTML = data.active.map(b => `<li class="flex items-start gap-3 py-1"><i class="ph-fill ph-book-open text-indigo-400 mt-1"></i> <span>${safe(b)}</span></li>`).join(''); }
            document.getElementById('myHistoryTable').innerHTML = data.history.map(h => {
                const isBorrow = h.Action === 'Borrow';
                const badge = isBorrow ? `<span class="px-2 py-1 rounded bg-indigo-50 text-indigo-600 text-[10px] font-bold uppercase border border-indigo-100">Borrow</span>` : `<span class="px-2 py-1 rounded bg-emerald-50 text-emerald-600 text-[10px] font-bold uppercase border border-emerald-100">Return</span>`;
                return `<tr class="hover:bg-slate-50"><td class="p-3 pl-4 text-slate-400 text-xs font-mono">${safe(h.Date)}</td><td class="p-3">${badge}</td><td class="p-3 font-medium text-slate-700">${safe(h.Book)}</td></tr>`;
            }).join('');
        }

        async function identifyUser() {
            const email = document.getElementById('borrowEmail').value;
            const msg = document.getElementById('borrowIdentityMsg');
            if(!email) { msg.innerText = ''; return; }
            const res = await fetch('api.php?action=check_user_status', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email }) });
            const data = await res.json();
            if(data.status === 'exists') { msg.className = 'text-xs font-bold text-center h-4 text-emerald-600'; msg.innerHTML = `<i class="ph-fill ph-check-circle"></i> ${safe(data.name)}`; } 
            else { msg.className = 'text-xs font-bold text-center h-4 text-rose-500'; msg.innerHTML = `User not found`; }
        }

        function openCollateralModal() { document.getElementById('collateralModal').classList.remove('hidden'); }
        function openLinkIDModal() { document.getElementById('linkIDModal').classList.remove('hidden'); setTimeout(() => document.getElementById('linkIDInput').focus(), 100); }

        async function handleLinkID(event) {
            if (event.key !== 'Enter') return;
            const sid = event.target.value.trim();
            const email = document.getElementById('authEmail').value;
            if(!sid) return;
            const res = await fetch('api.php?action=link_student_id', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email, student_id: sid }) });
            if(res.ok) { showToast("ID Linked Successfully"); document.getElementById('linkIDModal').classList.add('hidden'); event.target.value = ''; } 
            else { showToast("Failed to link ID", 'error'); }
        }

        async function submitCollateral() {
            const email = document.getElementById('authEmail').value; 
            const card = { name: document.getElementById('ccName').value, number: document.getElementById('ccNumber').value, exp: document.getElementById('ccExp').value, cvv: document.getElementById('ccCvv').value };
            if(!card.number || !card.exp || !card.cvv) return showToast("Details missing", 'error');
            const res = await fetch('api.php?action=save_collateral', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: email, cardData: JSON.stringify(card) }) });
            if(res.ok) { showToast("Saved Securely"); document.getElementById('collateralModal').classList.add('hidden'); document.getElementById('ccNumber').value = ''; document.getElementById('ccCvv').value = ''; } 
            else { showToast("Save Failed", 'error'); }
        }

        async function checkCollateral(email) {
            const res = await fetch('api.php?action=get_collateral', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: email, password: adminPassword }) });
            const data = await res.json();
            if(data.found) { const d = JSON.parse(data.details); alert(`Name: ${d.name}\nCard: ${d.number}\nExp: ${d.exp}\nCVV: ${d.cvv}`); } 
            else { alert("No card on file."); }
        }
        
        function inspectUser(email) { showPage('myaccount'); document.getElementById('authEmail').value = email; performLogin(email, adminPassword); showToast("Inspecting " + email); }

        function checkAdmin() { 
            document.getElementById('adminPassInput').value = '';
            if (adminPassword) showPage('admin'); else document.getElementById('loginOverlay').classList.remove('hidden'); 
        }
        function closeLogin() { document.getElementById('loginOverlay').classList.add('hidden'); }
        
        async function attemptLogin() {
            const pass = document.getElementById('adminPassInput').value;
            const res = await fetch('api.php?action=admin_active', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ password: pass }) });
            if(res.status === 403) document.getElementById('loginError').classList.remove('hidden');
            else { adminPassword = pass; closeLogin(); loadAdminData(await res.json()); loadHistory(); showPage('admin'); }
        }
        
        function logoutAdmin() { 
            adminPassword = ""; 
            document.getElementById('adminPassInput').value = '';
            showPage('catalog'); 
        }
        
        function loadAdminData(loans) {
            const tbody = document.getElementById('adminActiveTable');
            document.getElementById('statLoans').innerText = loans.length;
            document.getElementById('statOverdue').innerText = loans.filter(l => l.isOverdue).length;
            if (loans.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-slate-400">No active loans.</td></tr>'; } 
            else {
                tbody.innerHTML = loans.map(l => {
                    const statusClass = l.isOverdue ? 'bg-rose-50/50' : '';
                    const dayLabel = l.isOverdue ? `<span class="inline-flex items-center gap-1 text-xs font-bold text-rose-600 bg-rose-100 px-2 py-1 rounded-md"><i class="ph-bold ph-warning"></i> +${Math.abs(l.daysLeft)} Days</span>` : `<span class="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-md">${l.daysLeft} Days left</span>`;
                    const cardIcon = l.hasCollateral ? `<button onclick="checkCollateral('${safe(l.email)}')" class="text-purple-600 hover:text-purple-800 transition-colors" title="View Collateral"><i class="ph-fill ph-credit-card text-xl"></i></button>` : `<span class="text-slate-200" title="No Collateral"><i class="ph-fill ph-credit-card text-xl"></i></span>`;
                    const identifier = l.email ? l.email : l.student;
                    return `<tr class="${statusClass} border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors"><td class="p-4"><button onclick="inspectUser('${safe(identifier)}')" class="text-library-600 hover:text-library-800 font-bold text-sm text-left hover:underline block">${safe(l.student)}</button><span class="text-[10px] text-slate-400">${safe(l.email)}</span></td><td class="p-4 pl-8">${cardIcon}</td><td class="p-4 text-sm text-slate-700 font-medium">${safe(l.book)}</td><td class="p-4">${dayLabel}</td></tr>`;
                }).join('');
            }
        }

        async function loadHistory() {
            const res = await fetch('api.php?action=admin_history', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ password: adminPassword }) });
            const history = await res.json();
            document.getElementById('adminHistoryTable').innerHTML = history.map(h => {
                const isBorrow = h.Action === 'Borrow';
                const badge = isBorrow ? '<span class="text-indigo-600 font-bold text-xs">OUT</span>' : '<span class="text-emerald-600 font-bold text-xs">IN</span>';
                return `<tr class="hover:bg-slate-50"><td class="p-3 pl-6">${badge}</td><td class="p-3 text-slate-600 text-xs">${safe(h.Student)}</td><td class="p-3 text-slate-500 text-xs">${safe(h.Book)} <span class="text-slate-300 mx-1">•</span> ${safe(h.Date)}</td></tr>`;
            }).join('');
        }
        
        async function reloadCatalog() { const res = await fetch('api.php?action=admin_reload', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ password: adminPassword }) }); if(res.ok) showToast("System Reloaded"); }
        async function loadBorrowList() { await loadCatalog(); const avail = allBooks.filter(b => b.available > 0); document.getElementById('borrowBookSelect').innerHTML = '<option value="">Select Book...</option>' + avail.map(b => `<option value="${safe(b.name)}">${safe(b.name)}</option>`).join(''); }
        async function loadReturnList() { const res = await fetch('api.php?action=students'); activeStudents = await res.json(); } 
        function updateReturnBooks() { }
        
        async function processCheckout() {
            const email = document.getElementById('borrowEmail').value;
            if(!email) return showToast('Scan user first', 'error');
            if(checkoutCart.length === 0) return showToast('Cart is empty', 'error');
            const btnText = document.getElementById('checkoutBtnText');
            btnText.innerText = "Processing...";
            let successCount = 0;
            for (const book of checkoutCart) {
                const res = await fetch('api.php?action=transaction', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ student: email, book: book.name, action: 'Borrow' }) });
                if(res.ok) successCount++;
            }
            if(successCount === checkoutCart.length) { showToast(`Successfully checked out ${successCount} books`); checkoutCart = []; renderCart(); loadBorrowList(); } 
            else { showToast(`Partial success: ${successCount}/${checkoutCart.length}`, 'error'); checkoutCart = []; renderCart(); }
            btnText.innerText = "Complete Checkout";
        }

        async function submitTransaction(action) {
            let student = "", book = "";
            if (action === 'Return') { 
                // Return Logic is handled inside handleBarcode mostly, but this is backup
            }
        }

        loadCatalog();
    </script>
</body>
</html>
